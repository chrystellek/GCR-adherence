---
title: "Adherence Aim"
format: docx
editor: visual
editor_options: 
  chunk_output_type: console
execute:
  cache: false  
---

## Medication use during a pandemic

Chrystelle Kiang

### Note space

Here goes my attempt at using quarto for some of this dissertation aim text.

```{r}
#| warning: false
#| include: false

library(here) 
library(tidyverse)
library(gtsummary)
library(flextable)


# this dataset has all eligible study population 
# also has pharm data for some; not all pts have rx data
# created in data_creation.R 
pharmstudydata <- readRDS("studypopdata.rds")

pharmstudydata <- pharmstudydata %>%
      mutate(daily_dose = 1, # creating daily dose variable for AdhereR
         # combined diagnosis date variable 
         dt_diagnosis = as.Date(
           paste(CTCDATE_OF_DIAGNOSIS_YYYY,
           sprintf("%02d", as.numeric(CTCDATE_OF_DIAGNOSIS_MM)),
           sprintf("%02d", as.numeric(CTCDATE_OF_DIAGNOSIS_DD)),
           sep = "-"),
         format = "%Y-%m-%d"))
#TODO create collapsed asian and hisp group? do I even need to report hisp?

# subset pts who have rx and those who have rx after diagnosis
rx_before_dx <- pharmstudydata %>%
  filter(dispense_dt <= dt_diagnosis) %>%
    distinct(StudyID, .keep_all = TRUE)

pharmstudydata <- pharmstudydata %>% 
  anti_join(rx_before_dx, by = "StudyID") %>%
  filter(!is.na(dispense_dt)) %>% # only keep those with pharm info and after 2018
  filter(dispense_dt >= as.Date("2018-01-01", format = "%Y-%m-%d")) 
```

### Study Population

There are `r n_distinct(studydata$StudyID)` patients who had ER positive tumors, diagnosed stages I to III, and had any prescription starting on January 1, 2018.

There are some patients who have both AI and TAM! There are `r ndrug[1,1]` patients with only one and `r ndrug[2,1]` patients with two. For now, subsetting to patients with only one.

```{r}
#| echo: false
#| warning: false

table1 <- studydata %>% 
  distinct(StudyID, .keep_all = TRUE) %>%
  tbl_summary(include = c(sex, race, hispanic, marital_status, CTCAGE_AT_DIAGNOSIS, CTCDATE_OF_DIAGNOSIS_YYYY, laterality, stage_summary, estrogen_receptor, reporting_source), sort = list(c(sex,race) ~ "frequency"))

as_flex_table(table1)
```

#### 
